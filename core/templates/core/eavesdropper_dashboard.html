{% extends 'core/base.html' %}

{% block title %}Eavesdropper Dashboard{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-12">
            <!-- Page Header -->
            <div class="quantum-card mb-4" style="background: linear-gradient(135deg, rgba(220, 38, 38, 0.1), rgba(239, 68, 68, 0.1));">
                <div class="card-header border-danger">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h4 class="mb-2 fw-bold text-danger">
                                <i class="bi bi-eye-slash me-2"></i>Eavesdropper Dashboard (Eve)
                            </h4>
                            <p class="text-muted mb-0 fw-medium">Monitor quantum key exchange interceptions (Educational Demo)</p>
                        </div>
                        <div class="text-end">
                            <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left me-1"></i>Back
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Eavesdropper Status -->
            <div class="quantum-card mb-4" id="eavesdropperStatusCard">
                <div class="card-header">
                    <h5 class="mb-0 fw-bold">
                        <i class="bi bi-shield-exclamation me-2 text-warning"></i>Active Eavesdropper Status
                    </h5>
                </div>
                <div class="card-body">
                    {% if active_eavesdropper %}
                        <div class="alert alert-danger">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="fw-bold"><i class="bi bi-exclamation-triangle me-2"></i>Eavesdropper Active</h6>
                                    <dl class="row mb-0">
                                        <dt class="col-sm-5">Eve ID:</dt>
                                        <dd class="col-sm-7"><code>{{ active_eavesdropper.eavesdropper_id }}</code></dd>
                                        
                                        <dt class="col-sm-5">Injected By:</dt>
                                        <dd class="col-sm-7">{{ active_eavesdropper.injected_by }}</dd>
                                        
                                        <dt class="col-sm-5">Intercept Probability:</dt>
                                        <dd class="col-sm-7"><strong>{{ active_eavesdropper.intercept_probability|floatformat:2 }}</strong> ({{ intercept_percentage }}%)</dd>
                                        
                                        <dt class="col-sm-5">Activated At:</dt>
                                        <dd class="col-sm-7">{{ active_eavesdropper.activated_at|date:"M d, Y H:i:s" }}</dd>
                                    </dl>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="fw-bold"><i class="bi bi-bar-chart me-2"></i>Statistics</h6>
                                    <dl class="row mb-0">
                                        <dt class="col-sm-6">Sessions Intercepted:</dt>
                                        <dd class="col-sm-6"><strong class="text-danger">{{ active_eavesdropper.sessions_intercepted }}</strong></dd>
                                        
                                        <dt class="col-sm-6">Qubits Intercepted:</dt>
                                        <dd class="col-sm-6"><strong class="text-danger">{{ active_eavesdropper.total_qubits_intercepted }}</strong></dd>
                                        
                                        <dt class="col-sm-6">Times Detected:</dt>
                                        <dd class="col-sm-6"><strong class="text-warning">{{ active_eavesdropper.detections_count }}</strong></dd>
                                        
                                        <dt class="col-sm-6">Detection Rate:</dt>
                                        <dd class="col-sm-6">
                                            {% if detection_rate_percentage is not None %}
                                                {{ detection_rate_percentage|floatformat:0 }}%
                                                {% if detection_rate is not None %}
                                                    <small class="text-muted">({{ detection_rate|floatformat:2 }})</small>
                                                {% endif %}
                                            {% else %}
                                                N/A
                                            {% endif %}
                                        </dd>
                                    </dl>
                                </div>
                            </div>
                            <div class="mt-3 text-center">
                                <button class="btn btn-warning" onclick="deactivateEavesdropper()">
                                    <i class="bi bi-x-circle me-1"></i>Deactivate Eavesdropper
                                </button>
                            </div>
                        </div>
                    {% else %}
                        <div class="alert alert-info mb-0">
                            <div class="d-flex align-items-start">
                                <i class="bi bi-info-circle me-3 fs-3"></i>
                                <div>
                                    <h6 class="fw-bold mb-1">No active eavesdropper detected</h6>
                                    <p class="mb-2">Use the per-session intercept toggles below to simulate Eve. When you enable one, she will be waiting the moment the receiver accepts.</p>
                                    <ul class="mb-0 small text-muted ps-3">
                                        <li>Toggle <strong>Intercept</strong> on any pending request to prime Eve.</li>
                                        <li>Use the same toggle to stop intercepting.</li>
                                        <li>Deactivate Eve entirely once you finish testing.</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Pending Sessions -->
            <div class="quantum-card mb-4" id="pendingSessionsCard">
                <div class="card-header">
                    <h5 class="mb-0 fw-bold">
                        <i class="bi bi-hourglass-split me-2 text-warning"></i>Pending BB84 Requests
                    </h5>
                </div>
                <div class="card-body">
                    {% if pending_sessions %}
                        <p class="text-muted"><i class="bi bi-info-circle me-1"></i>These sessions have not started yet. Toggle intercept so Eve is waiting when the receiver accepts.</p>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Sender → Receiver</th>
                                        <th>Context</th>
                                        <th>Status</th>
                                        <th>Created</th>
                                        <th>Intercept?</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for session in pending_sessions %}
                                        <tr>
                                            <td>
                                                <div><strong>{{ session.sender.email }}</strong></div>
                                                <div class="small text-muted"><i class="bi bi-arrow-right"></i> {{ session.receiver.email }}</div>
                                            </td>
                                            <td>
                                                {% if session.context_type == 'group' %}
                                                    <span class="badge bg-primary"><i class="bi bi-people"></i> Group</span>
                                                    <div class="small text-muted">{{ session.group.name }}</div>
                                                {% else %}
                                                    <span class="badge bg-secondary"><i class="bi bi-person"></i> Personal</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if session.receiver_accepted %}
                                                    <span class="badge bg-info">Receiver Accepted</span>
                                                {% else %}
                                                    <span class="badge bg-warning text-dark">Awaiting Receiver</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <small class="text-muted">{{ session.created_at|date:"M d, Y H:i" }}</small>
                                            </td>
                                            <td>
                                                {% if session.force_eavesdrop %}
                                                    <span class="badge bg-danger"><i class="bi bi-lightning-charge"></i> Yes</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">No</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if session.force_eavesdrop %}
                                                    <button class="btn btn-sm btn-outline-secondary force-intercept-btn" data-session="{{ session.session_id }}" data-force="false">
                                                        <i class="bi bi-slash-circle"></i> Stop Intercept
                                                    </button>
                                                {% else %}
                                                    <button class="btn btn-sm btn-outline-danger force-intercept-btn" data-session="{{ session.session_id }}" data-force="true">
                                                        <i class="bi bi-lightning-charge"></i> Intercept
                                                    </button>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="bi bi-inbox text-muted" style="font-size: 2rem;"></i>
                            <p class="text-muted mt-2 mb-0">No pending BB84 requests right now.</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Active/Transmitting Sessions -->
            <div class="quantum-card mb-4" id="activeTransmissionsCard">
                <div class="card-header">
                    <h5 class="mb-0 fw-bold">
                        <i class="bi bi-broadcast me-2 text-primary"></i>Active Quantum Transmissions
                    </h5>
                </div>
                <div class="card-body">
                    {% if active_sessions %}
                        <p class="text-muted"><i class="bi bi-info-circle me-1"></i>Sessions currently in progress (can be intercepted if eavesdropper active)</p>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Sender → Receiver</th>
                                        <th>Status</th>
                                        <th>Current Phase</th>
                                        <th>Progress</th>
                                        <th>Intercepted</th>
                                        <th>Started</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for session in active_sessions %}
                                        <tr class="{% if session.eavesdropper_present %}table-danger{% endif %}">
                                            <td>
                                                <strong>{{ session.sender.email }}</strong>
                                                <br><i class="bi bi-arrow-right text-muted"></i>
                                                <strong>{{ session.receiver.email }}</strong>
                                            </td>
                                            <td>
                                                <span class="badge bg-info">{{ session.get_status_display }}</span>
                                            </td>
                                            <td>
                                                <small>{{ session.current_phase|default:"Pending..." }}</small>
                                            </td>
                                            <td>
                                                <div class="progress" style="height: 20px; width: 100px;">
                                                    <div class="progress-bar bg-primary" data-progress="{{ session.progress_percentage|default_if_none:0 }}">
                                                        {{ session.progress_percentage|default_if_none:0 }}%
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                {% if session.eavesdropper_present %}
                                                    <span class="badge bg-danger">
                                                        <i class="bi bi-eye-slash"></i> YES
                                                    </span>
                                                {% else %}
                                                    <span class="badge bg-success">NO</span>
                                                {% endif %}
                                                {% if session.force_eavesdrop %}
                                                    <div><small class="text-danger">Intercept waiting</small></div>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <small class="text-muted">{{ session.created_at|date:"H:i:s" }}</small>
                                            </td>
                                            <td>
                                                {% if session.status == 'accepted' or session.status == 'transmitting' or session.status == 'sifting' or session.status == 'checking' %}
                                                    {% if session.force_eavesdrop %}
                                                        <button class="btn btn-sm btn-outline-secondary force-intercept-btn" data-session="{{ session.session_id }}" data-force="false">
                                                            <i class="bi bi-slash-circle me-1"></i>Stop Intercept
                                                        </button>
                                                    {% else %}
                                                        <button class="btn btn-sm btn-outline-danger force-intercept-btn" data-session="{{ session.session_id }}" data-force="true">
                                                            <i class="bi bi-lightning-charge me-1"></i>Intercept
                                                        </button>
                                                    {% endif %}
                                                {% else %}
                                                    <span class="text-muted small">-</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="bi bi-broadcast-pin text-muted" style="font-size: 3rem;"></i>
                            <p class="text-muted mt-3">No quantum transmissions currently active.</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Recently Intercepted Sessions -->
            <div class="quantum-card" id="recentInterceptionsCard">
                <div class="card-header">
                    <h5 class="mb-0 fw-bold">
                        <i class="bi bi-clock-history me-2 text-secondary"></i>Recent Interceptions
                    </h5>
                </div>
                <div class="card-body">
                    {% if recent_intercepted_passed or recent_intercepted_failed %}
                        <div class="row g-4">
                            <div class="col-lg-6">
                                <div class="border rounded h-100 p-3">
                                    <h6 class="fw-bold text-success mb-3">
                                        <i class="bi bi-check-circle me-2"></i>Passed (Undetected)
                                    </h6>
                                    {% if recent_intercepted_passed %}
                                        <div class="table-responsive">
                                            <table class="table table-sm align-middle mb-0">
                                                <thead>
                                                    <tr>
                                                        <th>Parties</th>
                                                        <th>QBER</th>
                                                        <th>Detected?</th>
                                                        <th>Finished</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for session in recent_intercepted_passed %}
                                                        <tr>
                                                            <td>
                                                                <small>{{ session.sender.email }} → {{ session.receiver.email }}</small>
                                                            </td>
                                                            <td>
                                                                {% if session.error_rate %}
                                                                    <span class="{% if session.error_rate > 0.15 %}text-danger{% else %}text-success{% endif %}">
                                                                        {{ session.error_rate|floatformat:4 }}
                                                                    </span>
                                                                {% else %}
                                                                    N/A
                                                                {% endif %}
                                                            </td>
                                                            <td>
                                                                {% if session.error_rate and session.error_rate > 0.15 %}
                                                                    <span class="badge bg-warning">
                                                                        <i class="bi bi-exclamation-triangle"></i> Detected
                                                                    </span>
                                                                {% else %}
                                                                    <span class="badge bg-success">
                                                                        <i class="bi bi-shield-check"></i> Undetected
                                                                    </span>
                                                                {% endif %}
                                                            </td>
                                                            <td>
                                                                <small class="text-muted">{{ session.completed_at|default:session.updated_at|date:"M d, H:i" }}</small>
                                                            </td>
                                                        </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    {% else %}
                                        <div class="text-center py-4 text-muted small">
                                            <i class="bi bi-inbox"></i>
                                            <p class="mb-0 mt-2">No successful interceptions yet.</p>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="border rounded h-100 p-3">
                                    <h6 class="fw-bold text-danger mb-3">
                                        <i class="bi bi-exclamation-octagon me-2"></i>Failed (Detected)
                                    </h6>
                                    {% if recent_intercepted_failed %}
                                        <div class="table-responsive">
                                            <table class="table table-sm align-middle mb-0">
                                                <thead>
                                                    <tr>
                                                        <th>Parties</th>
                                                        <th>QBER</th>
                                                        <th>Detected?</th>
                                                        <th>Finished</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for session in recent_intercepted_failed %}
                                                        <tr>
                                                            <td>
                                                                <small>{{ session.sender.email }} → {{ session.receiver.email }}</small>
                                                            </td>
                                                            <td>
                                                                {% if session.error_rate %}
                                                                    <span class="{% if session.error_rate > 0.15 %}text-danger{% else %}text-success{% endif %}">
                                                                        {{ session.error_rate|floatformat:4 }}
                                                                    </span>
                                                                {% else %}
                                                                    N/A
                                                                {% endif %}
                                                            </td>
                                                            <td>
                                                                {% if session.error_rate and session.error_rate > 0.15 %}
                                                                    <span class="badge bg-warning">
                                                                        <i class="bi bi-exclamation-triangle"></i> Detected
                                                                    </span>
                                                                {% else %}
                                                                    <span class="badge bg-success">
                                                                        <i class="bi bi-shield-check"></i> Undetected
                                                                    </span>
                                                                {% endif %}
                                                            </td>
                                                            <td>
                                                                <small class="text-muted">{{ session.completed_at|default:session.updated_at|date:"M d, H:i" }}</small>
                                                            </td>
                                                        </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    {% else %}
                                        <div class="text-center py-4 text-muted small">
                                            <i class="bi bi-inbox"></i>
                                            <p class="mb-0 mt-2">No detected interceptions yet.</p>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="bi bi-inbox text-muted" style="font-size: 2rem;"></i>
                            <p class="text-muted mt-2 mb-0">No interceptions yet.</p>
                        </div>
                    {% endif %}
                </div>
            </div>

        </div>
    </div>
</div>

<script>
function getCsrfToken() {
    const name = 'csrftoken';
    const cookies = document.cookie ? document.cookie.split(';') : [];
    for (let i = 0; i < cookies.length; i += 1) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === `${name}=`) {
            return decodeURIComponent(cookie.substring(name.length + 1));
        }
    }
    return '';
}

function deactivateEavesdropper() {
    if (!confirm('Deactivate the active eavesdropper?')) return;

    fetch('/api/eavesdropper/deactivate/', {
        method: 'POST',
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Eavesdropper deactivated successfully!');
                return refreshEavesdropperSections();
            } else {
                alert('Error: ' + (data.error || data.message));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to deactivate eavesdropper');
        });
}

let isRefreshingEavesdropper = false;

async function fetchEavesdropperDom() {
    const response = await fetch(window.location.href, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        },
        credentials: 'same-origin',
    });

    const html = await response.text();
    const parser = new DOMParser();
    return parser.parseFromString(html, 'text/html');
}

function swapEavesdropperSection(doc, id) {
    const current = document.getElementById(id);
    const replacement = doc.getElementById(id);
    if (current && replacement) {
        current.replaceWith(replacement);
    }
}

function applyProgressWidths(scope = document) {
    scope.querySelectorAll('.progress-bar[data-progress]').forEach((bar) => {
        const progress = parseFloat(bar.dataset.progress);
        const clamped = Math.max(0, Math.min(Number.isNaN(progress) ? 0 : progress, 100));
        bar.style.width = `${clamped}%`;
    });
}

function bindForceInterceptButtons(scope = document) {
    scope.querySelectorAll('.force-intercept-btn').forEach((button) => {
        if (button.dataset.bound === 'true') {
            return;
        }

        button.addEventListener('click', () => handleForceInterceptToggle(button));
        button.dataset.bound = 'true';
    });
}

function handleForceInterceptToggle(button) {
    const sessionId = button.dataset.session;
    const shouldForce = button.dataset.force === 'true';
    const originalHtml = button.innerHTML;

    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status"></span>Processing';

    fetch(`/eavesdropper/sessions/${sessionId}/force/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken(),
        },
        body: JSON.stringify({ force: shouldForce }),
    })
        .then((response) => response.json().then((data) => ({ status: response.status, data })))
        .then(({ status, data }) => {
            if (status >= 200 && status < 300 && data.success) {
                alert(data.message || 'Updated intercept setting.');
                return refreshEavesdropperSections();
            }

            throw new Error(data.error || data.message || 'Failed to update session.');
        })
        .catch((error) => {
            console.error('Error forcing intercept:', error);
            alert(`Error: ${error.message}`);
        })
        .finally(() => {
            if (document.body.contains(button)) {
                button.disabled = false;
                button.innerHTML = originalHtml;
            }
        });
}

async function refreshEavesdropperSections() {
    if (isRefreshingEavesdropper) {
        return;
    }
    isRefreshingEavesdropper = true;

    try {
        const doc = await fetchEavesdropperDom();
        ['eavesdropperStatusCard', 'pendingSessionsCard', 'activeTransmissionsCard', 'recentInterceptionsCard'].forEach((id) => swapEavesdropperSection(doc, id));
        applyProgressWidths();
        bindForceInterceptButtons();
    } catch (error) {
        console.error('Error refreshing eavesdropper dashboard:', error);
    } finally {
        isRefreshingEavesdropper = false;
    }
}

document.addEventListener('DOMContentLoaded', () => {
    applyProgressWidths();
    bindForceInterceptButtons();

    setInterval(() => {
        if (document.hidden) {
            return;
        }
        refreshEavesdropperSections();
    }, 5000);
});
</script>

{% endblock %}
