{% extends 'core/base.html' %}

{% block title %}Quantum Key Exchange{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <!-- Page Header -->
            <div class="quantum-card mb-4">
                <div class="card-header">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h4 class="mb-2 fw-bold">
                                <i class="bi bi-broadcast me-2 text-primary"></i>BB84 Quantum Key Exchange
                            </h4>
                            <p class="text-muted mb-0 fw-medium">Manage key distribution sessions and initiate new quantum key exchanges</p>
                        </div>
                        <div class="text-end">
                            <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left me-1"></i>Dashboard
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Received Sessions (Pending Your Acceptance) -->
            {% if received_sessions %}
            <div class="quantum-card mb-4">
                <div class="card-header bg-warning bg-opacity-10">
                    <h5 class="mb-0 fw-bold text-warning">
                        <i class="bi bi-bell-fill me-2"></i>Pending Requests (Requires Your Acceptance)
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>From (Sender)</th>
                                    <th>Status</th>
                                    <th>QBER</th>
                                    <th>Sifted Bits</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for session in received_sessions %}
                                    <tr class="{% if session.status == 'pending' %}table-warning{% endif %}">
                                        <td>
                                            <strong>{{ session.sender.get_full_name|default:session.sender.username }}</strong>
                                            <br>
                                            <small class="text-muted">{{ session.sender.email }}</small>
                                        </td>
                                        <td>
                                            <span class="badge 
                                                {% if session.status == 'completed' %}bg-success
                                                {% elif session.status == 'failed' %}bg-danger
                                                {% elif session.status == 'pending' %}bg-warning text-dark
                                                {% else %}bg-info{% endif %}">
                                                {{ session.get_status_display }}
                                            </span>
                                            {% if session.context_type == 'group' %}
                                                <br><span class="badge bg-primary mt-1">
                                                    <i class="bi bi-people"></i> Group: {{ session.group.name }}
                                                </span>
                                            {% else %}
                                                <br><span class="badge bg-secondary mt-1">
                                                    <i class="bi bi-person"></i> Personal
                                                </span>
                                            {% endif %}
                                            {% if session.eavesdropper_present %}
                                                <br><small class="text-danger"><i class="bi bi-eye-slash"></i> Eavesdropper Detected</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if session.error_rate is not None %}
                                                <span class="{% if session.error_rate > 0.15 %}text-danger{% elif session.error_rate > 0.10 %}text-warning{% else %}text-success{% endif %}">
                                                    {{ session.error_rate|floatformat:4 }}
                                                </span>
                                            {% else %}
                                                <span class="text-muted">N/A</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if session.sifted_key_length %}
                                                {{ session.sifted_key_length }} bits
                                            {% else %}
                                                <span class="text-muted">N/A</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <small class="text-muted">{{ session.created_at|date:"M d, Y H:i" }}</small>
                                        </td>
                                        <td>
                                            {% if session.status == 'pending' and not session.receiver_accepted %}
                                                <form method="post" action="{% url 'accept_bb84_session' session.session_id %}" style="display: inline;">
                                                    {% csrf_token %}
                                                    <button type="submit" class="btn btn-sm btn-success">
                                                        <i class="bi bi-check-circle"></i> Accept & Run BB84
                                                    </button>
                                                </form>
                                                <div class="mt-2">
                                                    {% if session.force_eavesdrop %}
                                                        <button class="btn btn-sm btn-outline-secondary force-intercept-btn" data-session="{{ session.session_id }}" data-force="false">
                                                            <i class="bi bi-slash-circle"></i> Cancel Force
                                                        </button>
                                                        <small class="d-block text-danger mt-1"><i class="bi bi-lightning-charge"></i> Force intercept armed for start</small>
                                                    {% else %}
                                                        <button class="btn btn-sm btn-outline-danger force-intercept-btn" data-session="{{ session.session_id }}" data-force="true">
                                                            <i class="bi bi-lightning-charge"></i> Force Intercept on Start
                                                        </button>
                                                    {% endif %}
                                                </div>
                                            {% elif session.status == 'accepted' or session.status == 'transmitting' or session.status == 'sifting' or session.status == 'checking' %}
                                                <button class="btn btn-sm btn-info" onclick="showTimeline('{{ session.session_id }}')">
                                                    <i class="bi bi-hourglass-split"></i> View Progress
                                                </button>
                                                {% if session.force_eavesdrop %}
                                                    <button class="btn btn-sm btn-outline-secondary mt-1 force-intercept-btn" data-session="{{ session.session_id }}" data-force="false">
                                                        <i class="bi bi-slash-circle"></i> Cancel Force
                                                    </button>
                                                    <small class="d-block text-danger mt-1"><i class="bi bi-lightning-charge"></i> Force intercept enabled</small>
                                                {% else %}
                                                    <button class="btn btn-sm btn-outline-danger mt-1 force-intercept-btn" data-session="{{ session.session_id }}" data-force="true">
                                                        <i class="bi bi-lightning-charge"></i> Force Intercept
                                                    </button>
                                                {% endif %}
                                            {% elif session.status == 'completed' %}
                                                <span class="text-success small">
                                                    <i class="bi bi-arrow-left-right"></i> Ready (Bidirectional)
                                                </span>
                                            {% elif session.status == 'failed' %}
                                                <span class="text-danger small">
                                                    <i class="bi bi-x-circle-fill"></i> Failed
                                                </span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Sent Sessions -->
            {% if sent_sessions %}
            <div class="quantum-card mb-4">
                <div class="card-header">
                    <h5 class="mb-0 fw-bold">
                        <i class="bi bi-send me-2 text-primary"></i>Your Initiated Sessions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>To (Recipient)</th>
                                    <th>Status</th>
                                    <th>QBER</th>
                                    <th>Sifted Bits</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for session in sent_sessions %}
                                    <tr>
                                        <td>
                                            <strong>{{ session.receiver.get_full_name|default:session.receiver.username }}</strong>
                                            <br>
                                            <small class="text-muted">{{ session.receiver.email }}</small>
                                        </td>
                                        <td>
                                            <span class="badge 
                                                {% if session.status == 'completed' %}bg-success
                                                {% elif session.status == 'failed' %}bg-danger
                                                {% elif session.status == 'pending' %}bg-warning text-dark
                                                {% else %}bg-info{% endif %}">
                                                {{ session.get_status_display }}
                                            </span>
                                            {% if session.context_type == 'group' %}
                                                <br><span class="badge bg-primary mt-1">
                                                    <i class="bi bi-people"></i> Group: {{ session.group.name }}
                                                </span>
                                            {% else %}
                                                <br><span class="badge bg-secondary mt-1">
                                                    <i class="bi bi-person"></i> Personal
                                                </span>
                                            {% endif %}
                                            {% if session.status == 'pending' and not session.receiver_accepted %}
                                                <br><small class="text-muted"><i class="bi bi-hourglass"></i> Awaiting acceptance</small>
                                            {% endif %}
                                            {% if session.eavesdropper_present %}
                                                <br><small class="text-danger"><i class="bi bi-eye-slash"></i> Eavesdropper Detected</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if session.error_rate is not None %}
                                                <span class="{% if session.error_rate > 0.15 %}text-danger{% elif session.error_rate > 0.10 %}text-warning{% else %}text-success{% endif %}">
                                                    {{ session.error_rate|floatformat:4 }}
                                                </span>
                                            {% else %}
                                                <span class="text-muted">N/A</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if session.sifted_key_length %}
                                                {{ session.sifted_key_length }} bits
                                            {% else %}
                                                <span class="text-muted">N/A</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <small class="text-muted">{{ session.created_at|date:"M d, Y H:i" }}</small>
                                        </td>
                                        <td>
                                            {% if session.status == 'accepted' or session.status == 'transmitting' or session.status == 'sifting' or session.status == 'checking' %}
                                                <button class="btn btn-sm btn-info" onclick="showTimeline('{{ session.session_id }}')">
                                                    <i class="bi bi-hourglass-split"></i> View Progress
                                                </button>
                                                {% if session.force_eavesdrop %}
                                                    <button class="btn btn-sm btn-outline-secondary mt-1 force-intercept-btn" data-session="{{ session.session_id }}" data-force="false">
                                                        <i class="bi bi-slash-circle"></i> Cancel Force
                                                    </button>
                                                    <small class="d-block text-danger mt-1"><i class="bi bi-lightning-charge"></i> Force intercept enabled</small>
                                                {% else %}
                                                    <button class="btn btn-sm btn-outline-danger mt-1 force-intercept-btn" data-session="{{ session.session_id }}" data-force="true">
                                                        <i class="bi bi-lightning-charge"></i> Force Intercept
                                                    </button>
                                                {% endif %}
                                            {% elif session.status == 'pending' %}
                                                {% if session.force_eavesdrop %}
                                                    <button class="btn btn-sm btn-outline-secondary force-intercept-btn" data-session="{{ session.session_id }}" data-force="false">
                                                        <i class="bi bi-slash-circle"></i> Cancel Force
                                                    </button>
                                                    <small class="d-block text-danger mt-1"><i class="bi bi-lightning-charge"></i> Force intercept armed for start</small>
                                                {% else %}
                                                    <button class="btn btn-sm btn-outline-danger force-intercept-btn" data-session="{{ session.session_id }}" data-force="true">
                                                        <i class="bi bi-lightning-charge"></i> Force Intercept on Start
                                                    </button>
                                                {% endif %}
                                            {% elif session.status == 'completed' %}
                                                <span class="text-success small">
                                                    <i class="bi bi-arrow-left-right"></i> Ready (Bidirectional)
                                                </span>
                                            {% elif session.status == 'failed' %}
                                                <span class="text-danger small">
                                                    <i class="bi bi-x-circle-fill"></i> Failed
                                                </span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Initiate New Key Exchange -->
            <div class="row">
                <!-- Recipient Selection -->
                <div class="col-lg-8">
                    <div class="quantum-card">
                        <div class="card-header">
                            <h5 class="mb-0 fw-bold">
                                <i class="bi bi-people me-2 text-primary"></i>Select Recipients for Key Exchange
                            </h5>
                        </div>
                        <div class="card-body">
                            <!-- Info Alert -->
                            <div class="alert alert-info d-flex align-items-start mb-4" role="alert">
                                <i class="bi bi-info-circle-fill me-2 mt-1"></i>
                                <div class="small">
                                    <strong>BB84 Key Exchange Required:</strong> Before uploading files, you must establish quantum-safe shared secrets with each recipient through the BB84 protocol. This ensures only authorized parties can decrypt your files.
                                </div>
                            </div>

                            <form method="post" action="{% url 'initiate_key_exchange' %}" id="keyExchangeForm">
                                {% csrf_token %}
                                
                                <!-- Search Input -->
                                <div class="mb-3">
                                    <label for="userSearch" class="form-label">
                                        <i class="bi bi-search me-2"></i>Search Users
                                    </label>
                                    <input type="text" class="form-control" id="userSearch" placeholder="Type to search users..." autocomplete="off">
                                    <div class="form-text text-muted">Start typing to filter users by email or name</div>
                                </div>
                                
                                <!-- User Selection -->
                                <div class="mb-3">
                                    <label for="user_select" class="form-label">
                                        <i class="bi bi-person-check me-2"></i>Select Recipients
                                    </label>
                                    <select class="form-select" id="user_select" name="recipients" multiple size="10" required>
                                        <option value="" disabled class="text-muted">Choose users for key exchange...</option>
                                        {% for user in available_users %}
                                            <option value="{{ user.email }}" 
                                                    data-search="{{ user.email|lower }} {{ user.get_full_name|default:user.username|lower }}"
                                                    data-online="{{ user.online_status.is_online|default:False|yesno:'true,false' }}">
                                                {{ user.email }} ({{ user.get_full_name|default:user.username }})
                                                {% if user.online_status.is_online %}<span class="badge bg-success">Online</span>{% else %}<span class="badge bg-secondary">Offline</span>{% endif %}
                                            </option>
                                        {% endfor %}
                                    </select>
                                    <div class="form-text text-muted">
                                        Hold Ctrl/Cmd to select multiple users. BB84 sessions will be established with each selected recipient.
                                    </div>
                                </div>
                                
                                <!-- Action Buttons -->
                                <div class="d-grid gap-2 mb-3">
                                    <button type="button" class="btn btn-outline-secondary btn-sm" id="selectAll">
                                        <i class="bi bi-check-all me-1"></i>Select All Visible
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" id="clearSelection">
                                        <i class="bi bi-x-circle me-1"></i>Clear Selection
                                    </button>
                                </div>
                                
                                <!-- Selected Users Display -->
                                <div id="selectedUsers" style="display: none;">
                                    <label class="form-label small text-secondary">
                                        <i class="bi bi-people-fill me-1"></i>Selected Recipients:
                                    </label>
                                    <div id="selectedUsersList" class="d-flex flex-wrap gap-2 mb-3"></div>
                                </div>

                                <!-- Submit Button -->
                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-primary quantum-btn btn-lg" id="initiateBtn">
                                        <i class="bi bi-broadcast me-2"></i>Initiate BB84 Key Exchange Request
                                    </button>
                                </div>
                                
                                <div class="alert alert-info mt-3 mb-0">
                                    <i class="bi bi-info-circle me-2"></i>
                                    <strong>Note:</strong> Once established, quantum keys are permanent and work bidirectionally. Both users can securely exchange files indefinitely.
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Active Sessions Sidebar -->
                <div class="col-lg-4">
                    <!-- Active Sessions -->
                    <div class="quantum-card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0 fw-bold">
                                <i class="bi bi-activity me-2"></i>Active Sessions
                            </h6>
                        </div>
                        <div class="card-body">
                            {% if active_sessions %}
                                <div class="list-group list-group-flush">
                                    {% for session in active_sessions %}
                                        <div class="list-group-item px-0">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div class="flex-grow-1">
                                                    <h6 class="mb-1 small fw-bold">{{ session.receiver.username }}</h6>
                                                    <p class="mb-1 small text-muted">{{ session.receiver.email }}</p>
                                                    <span class="badge badge-sm 
                                                        {% if session.status == 'completed' %}bg-success
                                                        {% elif session.status == 'failed' %}bg-danger
                                                        {% elif session.status == 'pending' %}bg-warning
                                                        {% else %}bg-info{% endif %}">
                                                        {{ session.get_status_display }}
                                                    </span>
                                                </div>
                                                {% if session.status == 'completed' %}
                                                    <i class="bi bi-check-circle-fill text-success"></i>
                                                {% elif session.status == 'failed' %}
                                                    <i class="bi bi-x-circle-fill text-danger"></i>
                                                {% else %}
                                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                                        <span class="visually-hidden">In progress...</span>
                                                    </div>
                                                {% endif %}
                                            </div>
                                            {% if session.error_rate %}
                                                <div class="small text-muted mt-2">
                                                    QBER: {{ session.error_rate|floatformat:2 }}%
                                                </div>
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p class="text-muted small mb-0">No active key exchange sessions. Select recipients above to begin.</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Info Card -->
                    <div class="quantum-card">
                        <div class="card-header">
                            <h6 class="mb-0 fw-bold">
                                <i class="bi bi-question-circle me-2"></i>What is BB84?
                            </h6>
                        </div>
                        <div class="card-body">
                            <p class="small text-muted mb-2">
                                BB84 is a quantum key distribution protocol that allows two parties to establish a shared secret key with information-theoretic security.
                            </p>
                            <h6 class="small fw-bold mb-1">Key Features:</h6>
                            <ul class="small text-muted mb-0">
                                <li>Quantum state encoding (polarization bases)</li>
                                <li>Automatic eavesdropping detection</li>
                                <li>Privacy amplification</li>
                                <li>Information-theoretic security</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Timeline Progress Modal -->
<div class="modal fade" id="timelineModal" tabindex="-1" aria-labelledby="timelineModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content quantum-card">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold" id="timelineModalLabel">
                    <i class="bi bi-hourglass-split me-2 text-primary"></i>BB84 Protocol Timeline
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Session Info -->
                <div class="mb-3">
                    <strong>Session ID:</strong> <code id="modal-session-id"></code>
                </div>
                
                <!-- Current Phase -->
                <div class="alert alert-info mb-3">
                    <strong>Current Phase:</strong> <span id="modal-current-phase">Loading...</span>
                </div>
                
                <!-- Progress Bar -->
                <div class="mb-4">
                    <h6 class="fw-bold mb-2">Overall Progress:</h6>
                    <div class="progress" style="height: 30px;">
                        <div id="modal-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                             role="progressbar" 
                             style="width: 0%" 
                             aria-valuenow="0" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                            <span id="modal-progress-text">0%</span>
                        </div>
                    </div>
                </div>
                
                <!-- Timeline Visualization -->
                <div class="mb-3">
                    <h6 class="fw-bold mb-2">Protocol Timeline:</h6>
                    <div id="timeline-phases">
                        <!-- Phases will be populated here -->
                    </div>
                </div>
                
                <!-- Protocol Summary (shown after completion) -->
                <div id="protocol-summary" style="display: none;">
                    <h6 class="fw-bold mb-2">Protocol Summary:</h6>
                    <div class="card">
                        <div class="card-body">
                            <dl class="row mb-0">
                                <dt class="col-sm-4">Status:</dt>
                                <dd class="col-sm-8" id="summary-status"></dd>
                                
                                <dt class="col-sm-4">Sifted Bits:</dt>
                                <dd class="col-sm-8" id="summary-sifted-bits"></dd>
                                
                                <dt class="col-sm-4">Error Rate (QBER):</dt>
                                <dd class="col-sm-8" id="summary-error-rate"></dd>
                                
                                <dt class="col-sm-4">Eavesdropper:</dt>
                                <dd class="col-sm-8" id="summary-eavesdropper"></dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="refresh-timeline-btn" onclick="refreshTimeline()">
                    <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    /* User select styling */
    #user_select {
        min-height: 250px;
        border: 2px solid var(--border-color);
        border-radius: 12px;
        transition: all 0.2s ease;
    }

    #user_select:focus {
        border-color: var(--accent-blue);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    #user_select option {
        padding: 0.75rem;
        border-bottom: 1px solid rgba(226, 232, 240, 0.5);
        font-weight: 500;
    }

    #user_select option:disabled {
        background-color: rgba(248, 250, 252, 0.8);
        color: var(--text-muted);
        font-style: italic;
    }

    #user_select option[data-online="true"]:hover {
        background-color: rgba(34, 197, 94, 0.05);
    }

    #user_select option[data-online="false"]:hover {
        background-color: rgba(226, 232, 240, 0.3);
    }

    #user_select option:checked {
        background: linear-gradient(135deg, var(--accent-blue), #2563eb);
        color: white;
        font-weight: 600;
    }

    /* Selected user badges */
    .user-badge {
        background: rgba(59, 130, 246, 0.1);
        color: var(--accent-blue);
        border: 1px solid rgba(59, 130, 246, 0.2);
        border-radius: 8px;
        padding: 0.5rem 0.75rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s ease;
    }

    .user-badge:hover {
        background: rgba(59, 130, 246, 0.15);
        transform: translateY(-1px);
    }

    /* Progress items */
    .progress-item {
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 0.75rem;
        background: rgba(248, 250, 252, 0.8);
        border-left: 4px solid var(--border-color);
        transition: all 0.3s ease;
    }

    .progress-item.in-progress {
        border-left-color: var(--accent-blue);
        background: rgba(59, 130, 246, 0.05);
    }

    .progress-item.completed {
        border-left-color: #22c55e;
        background: rgba(34, 197, 94, 0.05);
    }

    .progress-item.failed {
        border-left-color: #ef4444;
        background: rgba(239, 68, 68, 0.05);
    }
</style>

<script>
function getCsrfToken() {
    const name = 'csrftoken';
    const cookies = document.cookie ? document.cookie.split(';') : [];
    for (let i = 0; i < cookies.length; i += 1) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === `${name}=`) {
            return decodeURIComponent(cookie.substring(name.length + 1));
        }
    }
    return '';
}

document.addEventListener('DOMContentLoaded', function() {
    const userSelect = document.getElementById('user_select');
    const userSearch = document.getElementById('userSearch');
    const selectedUsers = document.getElementById('selectedUsers');
    const selectedUsersList = document.getElementById('selectedUsersList');
    const clearSelectionBtn = document.getElementById('clearSelection');
    const selectAllBtn = document.getElementById('selectAll');
    const keyExchangeForm = document.getElementById('keyExchangeForm');

    // Store all options for filtering
    const allOptions = Array.from(userSelect.options).filter(option => option.value !== '');
    
    // Search functionality
    userSearch.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        
        allOptions.forEach(option => {
            const searchText = option.dataset.search || '';
            if (searchText.includes(searchTerm)) {
                option.style.display = '';
            } else {
                option.style.display = 'none';
            }
        });
    });
    
    // Selection management
    userSelect.addEventListener('change', updateSelectedUsersList);
    
    function updateSelectedUsersList() {
        const selected = Array.from(userSelect.selectedOptions).filter(opt => opt.value !== '');
        
        if (selected.length === 0) {
            selectedUsers.style.display = 'none';
            return;
        }
        
        selectedUsers.style.display = 'block';
        selectedUsersList.innerHTML = selected.map(option => `
            <span class="user-badge">
                ${option.text.split('(')[0].trim()}
                <button type="button" class="btn-close btn-sm" onclick="deselectUser('${option.value}')"></button>
            </span>
        `).join('');
    }
    
    window.deselectUser = function(email) {
        Array.from(userSelect.options).forEach(option => {
            if (option.value === email) {
                option.selected = false;
            }
        });
        updateSelectedUsersList();
    };
    
    // Clear all
    clearSelectionBtn.addEventListener('click', function() {
        userSelect.selectedIndex = -1;
        updateSelectedUsersList();
    });
    
    // Select all visible
    selectAllBtn.addEventListener('click', function() {
        allOptions.forEach(option => {
            if (option.style.display !== 'none') {
                option.selected = true;
            }
        });
        updateSelectedUsersList();
    });
    
    // Form submission
    keyExchangeForm.addEventListener('submit', function(e) {
        const selected = Array.from(userSelect.selectedOptions).filter(opt => opt.value !== '');
        
        if (selected.length === 0) {
            e.preventDefault();
            alert('Please select at least one recipient for key exchange.');
            return;
        }
    });

    document.querySelectorAll('.force-intercept-btn').forEach((button) => {
        button.addEventListener('click', function() {
            const sessionId = button.dataset.session;
            const shouldForce = button.dataset.force === 'true';
            const originalHtml = button.innerHTML;

            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status"></span>Processing';

            fetch(`/eavesdropper/sessions/${sessionId}/force/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken(),
                },
                body: JSON.stringify({ force: shouldForce }),
            })
                .then((response) => response.json().then((data) => ({ status: response.status, data })))
                .then(({ status, data }) => {
                    if (status >= 200 && status < 300 && data.success) {
                        alert(data.message || 'Updated force intercept setting.');
                        window.location.reload();
                    } else {
                        throw new Error(data.error || data.message || 'Failed to update session.');
                    }
                })
                .catch((error) => {
                    console.error('Error forcing intercept:', error);
                    alert(`Error: ${error.message}`);
                })
                .finally(() => {
                    button.disabled = false;
                    button.innerHTML = originalHtml;
                });
        });
    });
});

// Timeline modal functions
let currentSessionId = null;
let timelineInterval = null;

function showTimeline(sessionId) {
    currentSessionId = sessionId;
    document.getElementById('modal-session-id').textContent = sessionId;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('timelineModal'));
    modal.show();
    
    // Start polling
    refreshTimeline();
    timelineInterval = setInterval(refreshTimeline, 2000); // Poll every 2 seconds
    
    // Stop polling when modal closes
    document.getElementById('timelineModal').addEventListener('hidden.bs.modal', function() {
        if (timelineInterval) {
            clearInterval(timelineInterval);
            timelineInterval = null;
        }
    }, { once: true });
}

function refreshTimeline() {
    if (!currentSessionId) return;
    
    fetch(`/key-exchange/status/${currentSessionId}/`)
        .then(response => response.json())
        .then(data => {
            // Update current phase
            const phaseDisplay = document.getElementById('modal-current-phase');
            phaseDisplay.textContent = data.current_phase || 'Pending...';
            
            // Update progress bar
            const progressBar = document.getElementById('modal-progress-bar');
            const progressText = document.getElementById('modal-progress-text');
            const progress = data.progress_percentage || 0;
            
            progressBar.style.width = progress + '%';
            progressBar.setAttribute('aria-valuenow', progress);
            progressText.textContent = progress + '%';
            
            // Update progress bar color based on status
            progressBar.className = 'progress-bar progress-bar-striped';
            if (data.status === 'completed') {
                progressBar.classList.add('bg-success');
                progressBar.classList.remove('progress-bar-animated');
            } else if (data.status === 'failed') {
                progressBar.classList.add('bg-danger');
                progressBar.classList.remove('progress-bar-animated');
            } else {
                progressBar.classList.add('bg-primary', 'progress-bar-animated');
            }
            
            // Render timeline phases
            if (data.phase_timeline && data.phase_timeline.length > 0) {
                renderTimeline(data.phase_timeline);
            }
            
            // Show summary if completed/failed
            if (data.status === 'completed' || data.status === 'failed') {
                clearInterval(timelineInterval);
                timelineInterval = null;
                showProtocolSummary(data);
                
                // Reload page after 3 seconds to show updated status
                setTimeout(() => location.reload(), 3000);
            }
        })
        .catch(error => {
            console.error('Error fetching timeline:', error);
        });
}

function renderTimeline(timeline) {
    const container = document.getElementById('timeline-phases');
    container.innerHTML = '';
    
    const phaseIcons = {
        'preparation': 'bi-gear',
        'encoding': 'bi-code-square',
        'transmission_start': 'bi-arrow-left-right',
        'eavesdropper_active': 'bi-eye-slash text-warning',
        'measurement': 'bi-rulers',
        'basis_comparison': 'bi-arrow-repeat',
        'sifting_complete': 'bi-funnel',
        'error_estimation': 'bi-calculator',
        'error_rate_computed': 'bi-speedometer2',
        'eavesdropper_detected': 'bi-exclamation-triangle text-danger',
        'privacy_amplification': 'bi-shield-lock',
        'completed': 'bi-check-circle text-success'
    };
    
    timeline.forEach((phase, index) => {
        const phaseDiv = document.createElement('div');
        phaseDiv.className = 'mb-2 p-2 border-start border-3 border-primary ps-3';
        
        const icon = phaseIcons[phase.phase] || 'bi-circle';
        const timestamp = new Date(phase.timestamp).toLocaleTimeString();
        
        phaseDiv.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <i class="bi ${icon} me-2"></i>
                    <strong>${formatPhaseName(phase.phase)}</strong>
                </div>
                <small class="text-muted">${timestamp}</small>
            </div>
            ${phase.sifted_bits ? `<small class="text-muted ms-4">Sifted: ${phase.sifted_bits} bits</small>` : ''}
            ${phase.error_rate !== undefined ? `<small class="text-muted ms-4">QBER: ${(phase.error_rate * 100).toFixed(2)}%</small>` : ''}
        `;
        
        container.appendChild(phaseDiv);
    });
}

function formatPhaseName(phase) {
    const names = {
        'preparation': 'Phase 1: Quantum State Preparation',
        'encoding': 'Phase 1: Encoding Quantum States',
        'transmission_start': 'Phase 2: Quantum Transmission Started',
        'eavesdropper_active': '⚠️ Eavesdropper Intercepting!',
        'measurement': 'Phase 2: Receiver Measuring States',
        'basis_comparison': 'Phase 3: Basis Comparison',
        'sifting_complete': 'Phase 3: Key Sifting Complete',
        'error_estimation': 'Phase 4: Error Rate Estimation',
        'error_rate_computed': 'Phase 4: QBER Computed',
        'eavesdropper_detected': '❌ EAVESDROPPING DETECTED!',
        'privacy_amplification': 'Phase 5: Privacy Amplification',
        'completed': '✅ Protocol Completed Successfully'
    };
    return names[phase] || phase.replace(/_/g, ' ').toUpperCase();
}

function showProtocolSummary(data) {
    const summaryDiv = document.getElementById('protocol-summary');
    summaryDiv.style.display = 'block';
    
    document.getElementById('summary-status').innerHTML = `<span class="badge bg-${data.status === 'completed' ? 'success' : 'danger'}">${data.status.toUpperCase()}</span>`;
    document.getElementById('summary-sifted-bits').textContent = data.summary?.sifted_bits || 'N/A';
    document.getElementById('summary-error-rate').textContent = data.summary?.error_rate || 'N/A';
    document.getElementById('summary-eavesdropper').textContent = data.summary?.eavesdropper || 'None';
}
</script>

<style>
#timeline-phases {
    max-height: 400px;
    overflow-y: auto;
}

.progress {
    border-radius: 10px;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
}

.border-start {
    border-left-width: 4px !important;
}

#timeline-phases > div {
    background: rgba(248, 250, 252, 0.8);
    border-radius: 8px;
    transition: all 0.2s;
}

#timeline-phases > div:hover {
    background: rgba(59, 130, 246, 0.05);
    transform: translateX(5px);
}
</style>
{% endblock %}
